<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="shortcut icon" href="/favicon.ico">
        <link rel="stylesheet preload" as="style" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=block">
        <link rel="stylesheet preload" as="style" href="/css/style.css">
        <title>hanziKR's web!</title>
        <script src="/gCookie.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/sha256.js"></script>
        <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    </head>
    <script>
        window.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector("form");
            
            form.onsubmit = (event) => {
                event.preventDefault();

                const id = event.target.id.value.toLowerCase();
                const password = event.target.password.value;
                const message = document.getElementById("message");

                message.textContent = "";

                const passwordHash = String(CryptoJS.SHA256(password)).toUpperCase();
                const xmlHttp = new XMLHttpRequest();
                xmlHttp.onload = () => {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                        const response = JSON.parse(xmlHttp.response);
                        if (!response.success) {
                            grecaptcha.reset();
                            switch (response.msg) {
                                case "iorp": {
                                    message.textContent = "id나 password가 잘못되었습니다";
                                    break;
                                }
                                case "recaptcha": {
                                    message.textContent = "로봇이 아님을 증명하지 못했습니다";
                                    break;
                                }
                                case "exist": {
                                    message.textContent = "다른 유저가 사용중인 id입니다";
                                    break;
                                }
                                default: {
                                    message.textContent = "알 수 없는 오류가 발생했습니다";
                                    break;
                                }
                            }
                        }
                        else {
                            const url = new URL(window.location.href);
                            const c = url.searchParams.get("c");
                            
                            if (!c || !c.startsWith("https://hanzikr.github.io")) {
                                window.location.href = "/";
                            }
                            else {
                                window.location.href = c;
                            }
                        }
                    }
                };
                const recres = event.target["g-recaptcha-response"].value;
                let params = "";
                params += "g-recaptcha-response=" + recres + "&";
                params += "id=" + id + "&";
                params += "password=" + passwordHash;

                xmlHttp.open("POST", "https://hanzikr.kro.kr/signup", true);

                xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xmlHttp.send(params);
            };
        });
    </script>
    <body>
        <div id="container">
            <div style="margin-bottom:30px">
                <a href="/">
                    <img src="logo.svg" id="logo" width="150px" height="150px" alt="logo">
                </a>
            </div>
            <form id="form">
                <fieldset style="width:450px">
                    <legend style="font-size: 25px; margin-bottom: 5px">SIGNUP</legend>
                    <p style="font-size: 15px;" class="light" id="message"></p>
                    <label for="id" style="font-size: 20px;" class="llabel">ID(영어, 숫자만 5~20자)</label>
                    <input type="text" class="light-input" style="width:100%" name="id" id="id" maxlength="20" required/>
                    <label for="password" style="font-size: 20px;" class="llabel">PASSWORD(제한없음)</label>
                    <input type="password" class="light-input" style="width:100%" name="password" id="password" required/>
                    <div class="g-recaptcha" data-theme="dark" data-sitekey="6Lf4W_8bAAAAAKOS3Viigk9Sdd4LuD-2-upPkaFv"></div>
                    <input type="submit" class="light-button" style="margin-top:10px; width:100%" value="회원가입"/>
                </fieldset>
            </form>
        </div>
    </body>
</html>