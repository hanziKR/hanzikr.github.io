<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width">
    <title>Mstag(My storage)</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script></head>
    <script type="text/javascript">
    $(() => {
        // $("#encrypt").click(() => {
        //     let data = $("#data").val();
        //     let key = $("#key").val();
        //     let iv = $("#iv").val();
        //     let encrypted = CryptoJS.AES.encrypt(data, key, {
        //         iv: iv,
        //         mode: CryptoJS.mode.CBC
        //     }).toString();
        //     alert(encrypted);
        // });
        // $("#decrypt").click(() => {
        //     let data = $("#data").val();
        //     let key = $("#key").val();
        //     let iv = $("#iv").val();
        //     let decrypted = CryptoJS.AES.decrypt(data, key, {
        //         iv: iv,
        //         mode: CryptoJS.mode.CBC
        //     }).toString();
        //     alert(decrypted);
        // });

        let req = new XMLHttpRequest();
        // req.open("GET", "/sample.jpg", true);
        // req.open("GET", "/sample.mp4", true);
        // req.open("GET", "/sample.avi", true);
        // req.open("GET", "/sample.webm", true);
        // req.open("GET", "/sample.mov", true);
        // req.open("GET", "/sample.png", true);
        // req.open("GET", "/sample.bmp", true);
        // req.open("GET", "/sample.gif", true);
        req.open("GET", "/archlinux-2021.07.01-x86_64.iso", true);
        req.responseType = "arraybuffer";
        
        function byteStartsWith(buffer, data) {
            buffer = new Uint8Array(buffer);
            data = new Uint8Array(data);
            for (let i = 0; i < data.byteLength; i++) {
                if (buffer[i] != data[i]) return false;
            }
            return true;
        }
        function getFileType(data) {
            if (byteStartsWith(data, [0x42,0x4D])) return "image/bmp";
            if (byteStartsWith(data, [0x47,0x49,0x46,0x38])) return "image/gif";
            if (byteStartsWith(data, [0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A])) return "image/png";
            if (byteStartsWith(data, [255,0xD8])) return "image/jpeg";
            if (byteStartsWith(data, [0x66,0x74,0x79,0x70])) return "video/mp4";
            if (byteStartsWith(data, [0])) return "video/quicktime"
            if (byteStartsWith(data, [0x1A,0x45,0xDF,0xA3])) return "video/webm"
            else return "unknown";
        }

        let container = $("#container");
        let status = $("<div class='statustext'></div>");
        let progress = $("<div class='progress'></div>");
        let progressbar = $("<div class='progressbar'></div>");
        let progressDisplay = $("<p class='progresstext'></p>");
        container.append(status);
        progress.append(progressbar);
        container.append(progress);
        container.append(progressDisplay);

        status.text("다운로드중...");
        req.onprogress = (event) => {
            if (event.lengthComputable) {
                let progressData = Math.floor((event.loaded / event.total * 100) * 100) / 100;
                progressbar.width(progressData + "%");
                progressDisplay.text(progressData + "%");
            }
        }
        req.onload = (event) => {
            if (Math.floor(req.status / 100) == 2) {
                //let type = req.getResponseHeader("content-type");
                let supported = true;
                let frame;
                
                let byteArray = new Uint8Array(req.response);
                // if (byteStartsWith(req.response, [0x42,0x4D]) || //BMP
                //     byteStartsWith(req.response, [0x47,0x49,0x46,0x38]) || //GIF
                //     byteStartsWith(req.response, [0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A]) || //PNG
                //     byteStartsWith(req.response, [255,0xD8])) { //JPG
                //     frame = $("<img></img>");
                //     frame.attr("alt", "이미지");
                // }
                // else if (byteStartsWith(req.response, [0x66,0x74,0x79,0x70]) || //MP4
                //     byteStartsWith(req.response, [0]) || //MOV
                //     byteStartsWith(req.response, [0x1A,0x45,0xDF,0xA3])) { //WEBM
                //     frame = $("<video controls></video>");
                //     frame.attr("width", "auto");
                //     frame.attr("height", "auto");
                // }
                // else {
                //     status.text("지원하지 않는 파일 형식입니다.");
                //     console.log("unsupported");
                //     supported = false;
                // }
                let type = getFileType(req.response);
                if (type.startsWith("image")) {
                    frame = $("<img></img>");
                    frame.attr("alt", "이미지");
                }
                else if (type.startsWith("video")) {
                    frame = $("<video controls></video>");
                    frame.attr("width", "auto");
                    frame.attr("height", "auto");
                }
                else {
                    status.text("지원하지 않는 파일 형식입니다.");
                    console.log("unsupported");
                    supported = false;
                }
                
                if (supported) {
                    let blob = new Blob([req.response], { type: type });
                    let url = URL.createObjectURL(blob);
                    frame.attr("class", "frame");
                    frame.attr("src", url);
                    container.append(frame);

                    $(frame).on("load", () => {
                        URL.revokeObjectURL(url);
                    });
                    
                }
                
                let db = $("<input type='image' src='d.svg' width='50px' height='50px' alt='download'/>");
                db.click(() => {
                    status.text("다운로드 로딩중...");
                    let dba = $("<a class='hidden' target='_blank'/>");
                    let durl = window.URL.createObjectURL(new Blob([req.response], {type: "application/octet-stream"}));
                    dba.attr("href", durl);
                    dba.attr("download", "hi");
                    $("body").append(dba);
                    dba[0].click();
                    window.URL.revokeObjectURL(durl);
                    dba.remove();
                });

                container.append(db);
            }
        };
        req.send();
    });
    </script>
</head>
<body>
    <div id="container">
    </div>
</body>
</html>